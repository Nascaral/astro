---
import { getCollection, render } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import TestimonialCard from '../components/TestimonialCard.astro';

const testimonials = await getCollection('testimonials');

// Precompute everything BEFORE the HTML portion
const testimonialsWithContent = await Promise.all(
  testimonials.map(async (testimonial) => {
    const { Content } = await render(testimonial);
    const html = await Content(); // render to HTML string
    return { testimonial, html };
  })
);
---
<div class="testimonials-grid">
  {testimonialsWithContent.map(({ testimonial, html }) => (
    <TestimonialCard
      testimonial={testimonial}
      content={html}
    />
  ))}
</div>
